import os
import asyncio
import logging
from datetime import datetime
from pathlib import Path
from sqlalchemy import select, and_
from sqlalchemy.ext.asyncio import AsyncSession

# å¯¼å…¥é¡¹ç›®æ¨¡å—
from backend.database.connection import AsyncSessionLocal
from backend.models.mcp_service import MCPService, ServiceStatus
from backend.mcpybarra_core.framework.mcp_swe_flow.nodes.swe_generator import swe_generate_node
from backend.config.settings import settings

# é…ç½®æ—¥å¿—
logger = logging.getLogger("worker.service")

async def process_pending_services():
    """
    æ ¸å¿ƒå·¥ä½œå‡½æ•°ï¼š
    1. æŸ¥æ‰¾æ‰€æœ‰çŠ¶æ€ä¸º GENERATING ä¸” ä»£ç ä¸ºç©º çš„ä»»åŠ¡
    2. é€ä¸ªå¤„ç†
    """
    async with AsyncSessionLocal() as session:
        try:
            # 1. æŸ¥æ‰¾å¾…å¤„ç†ä»»åŠ¡
            # ä¿®æ­£ï¼šæ ¹æ®ä½ çš„æ¨¡å‹å®šä¹‰ï¼Œæ–°ä»»åŠ¡é»˜è®¤æ˜¯ GENERATING
            # æˆ‘ä»¬å¢åŠ ä¸€ä¸ªæ¡ä»¶ï¼šcode ä¸ºç©ºï¼Œç¡®ä¿åªå¤„ç†æ–°ä»»åŠ¡ï¼Œä¸é‡å¤å¤„ç†æ­£åœ¨è·‘çš„ä»»åŠ¡
            result = await session.execute(
                select(MCPService).where(
                    and_(
                        MCPService.status == ServiceStatus.GENERATING,
                        (MCPService.code == None) | (MCPService.code == "")
                    )
                )
            )
            pending_services = result.scalars().all()
            
            if not pending_services:
                return 

            logger.info(f"ğŸš€ Found {len(pending_services)} new services to process")

            # 2. é€ä¸ªå¤„ç†ä»»åŠ¡
            for service in pending_services:
                await process_single_service(session, service)
                
        except Exception as e:
            logger.error(f"âŒ Error in process_pending_services: {e}", exc_info=True)


async def process_single_service(session: AsyncSession, service: MCPService):
    """å¤„ç†å•ä¸ªæœåŠ¡ç”Ÿæˆæµç¨‹"""
    service_id = service.id
    logger.info(f"ğŸ‘‰ Starting processing for service: {service.name} ({service_id})")

    try:
        # Step 1: æ›´æ–°æ—¶é—´æˆ³ï¼Œè¡¨ç¤º Worker æ­£åœ¨æ´»è·ƒå¤„ç†
        service.updated_at = datetime.utcnow()
        await session.commit()
        
        # Step 2: å‡†å¤‡ç”Ÿæˆå‚æ•°
        state = {
            "user_input": service.original_requirement,
            "project_path": service.file_path or "",  
            "demo_mode": False,
            "verbose": True
        }
        
        logger.info(f"ğŸ¤– Generating code with LLM for {service_id}...")

        # Step 3: è°ƒç”¨ç”Ÿæˆé€»è¾‘
        # è¿™å¯èƒ½ä¼šèŠ±è´¹ä¸€äº›æ—¶é—´
        result_state = await swe_generate_node(state)
        
        generated_code = result_state.get("implementation_code", "")
        test_code = result_state.get("test_code", "")
        error = result_state.get("error")

        if error:
            raise Exception(f"LLM Generation failed: {error}")

        if not generated_code:
            raise Exception("LLM returned empty code")

        logger.info(f"âœ… Code generated successfully for {service_id}")

        # Step 4: ä¿å­˜ä»£ç åˆ°æ–‡ä»¶ç³»ç»Ÿ
        # ç¡®ä¿ç›®å½•å­˜åœ¨
        # å¦‚æœ file_path ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤è·¯å¾„
        if not service.file_path:
             service_dir = Path(settings.SERVICES_DIR) / service_id
        else:
             service_dir = Path(service.file_path)
             
        service_dir.mkdir(parents=True, exist_ok=True)
        
        # ä¿å­˜ä¸»ä»£ç 
        main_file = service_dir / "main.py"
        with open(main_file, "w", encoding="utf-8") as f:
            f.write(generated_code)
            
        # ä¿å­˜æµ‹è¯•ä»£ç 
        if test_code:
            test_file = service_dir / "test_main.py"
            with open(test_file, "w", encoding="utf-8") as f:
                f.write(test_code)
        
        # ä¿å­˜ README
        readme_file = service_dir / "README.md"
        with open(readme_file, "w", encoding="utf-8") as f:
            f.write(f"# {service.name}\n\n{service.description}\n\nGenerated by MCP-SWE-Agent")

        # Step 5: æ›´æ–°æ•°æ®åº“çŠ¶æ€
        # é‡æ–°è·å–å¯¹è±¡é˜²æ­¢ Session å†²çª
        result = await session.execute(select(MCPService).where(MCPService.id == service_id))
        service = result.scalar_one()

        service.code = generated_code
        # ä¿®æ­£ï¼šæ¨¡å‹é‡Œæ²¡æœ‰ COMPLETEDï¼Œæ”¹ä¸º READY
        service.status = ServiceStatus.READY 
        service.file_path = str(service_dir)
        service.updated_at = datetime.utcnow()
        
        await session.commit()
        logger.info(f"ğŸ‰ Service {service_id} processing COMPLETED (Status: READY)!")

    except Exception as e:
        logger.error(f"âŒ Failed to process service {service_id}: {e}", exc_info=True)
        
        try:
            result = await session.execute(select(MCPService).where(MCPService.id == service_id))
            service = result.scalar_one()
            
            service.status = ServiceStatus.FAILED
            service.total_errors += 1
            service.updated_at = datetime.utcnow()
            if service.description:
                service.description += f"\n\n[Error Log]: {str(e)}"
            
            await session.commit()
            logger.info(f"âš ï¸ Marked service {service_id} as FAILED")
        except Exception as db_e:
            logger.critical(f"ğŸ”¥ Critical DB error: {db_e}")
